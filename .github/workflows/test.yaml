name: Tests
on:
  push:
    branches:
      - main
      - 'release-*'
  pull_request:
    branches:
      - main
      - 'release-*'

env:
  RANCHER_VERSION: head
  TEST_USERNAME: admin
  TEST_PASSWORD: password
  CATTLE_BOOTSTRAP_PASSWORD: password
  TEST_BASE_URL: https://127.0.0.1
  API: https://127.0.0.1
  TEST_SKIP: setup

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup env
        uses: ./.github/actions/setup

      - name: Install Rancher
        run: .github/scripts/install-rancher.sh ${{ env.RANCHER_VERSION }}

      # - name: Install AI assistant chat
      #   run: echo "TODO: install AI assistant chart"

      - name: Start Mock Agent
        working-directory: ./mock-agent
        run: |
          yarn install --frozen-lockfile
          nohup yarn mock:agent:start > mock-agent.log 2>&1 & echo $! > mock-agent.pid

      - name: Start dev server
        env:
          API: ${{ env.API }}
          VUE_APP_AGENT_MESSAGES_WS_PATH: ws://localhost:8000/ws/agent
        run: |
          nohup yarn dev > dev.log 2>&1 & echo $! > dev.pid

      - name: Wait for UI and Mock Agent to be ready
        run: |
          npx wait-on https://localhost:8005 http://localhost:8000 || (cat mock-agent.log && tail -n 200 dev.log && exit 1)

      - name: Run Cypress tests
        id: cypress
        continue-on-error: true
        run: |
          yarn e2e --browser chrome

      # - name: Upload videos on failure
      #   if: steps.cypress.outcome != 'success'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: cypress-videos
      #     path: cypress/videos

      - name: Tear down background processes
        if: always()
        run: |
          if [ -f dev.pid ]; then kill $(cat dev.pid) || true; fi
          if [ -f mock-agent.pid ]; then kill $(cat mock-agent.pid) || true; fi

  i18n:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run i18n lint
        uses: ./.github/actions/i18n-lint

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Run tests
        uses: ./.github/actions/lint